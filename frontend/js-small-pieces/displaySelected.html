<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Display Selected Images</title>
    <link href="display.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-1.8.3.min.js"></script>

    <link href="../assets/plugins/bootstrap/css/bootstrap.css" rel="stylesheet">
    <link href="../assets/plugins/font-awesome/css/font-awesome.min.css" rel="stylesheet">
    <link href="../assets/plugins/icomoon/style.css" rel="stylesheet">
    <!--    <link href="assets/plugins/uniform/css/default.css" rel="stylesheet"/>-->
    <!--    <link href="assets/plugins/switchery/switchery.min.css" rel="stylesheet"/>-->
</head>
<body>

<h1>Select multiple</h1>

<input type="file" id="fileInput" multiple accept="image/*" style="display:none" onchange="handleFiles(this.files)">
<button id="fileButton">Select files</button>

<h1>Select one by one</h1>

<label for="src0"><img id="target0" src="../images/book-placeholder.png" class="thumbnail"/></label>
<input id="src0" type="file"/>
<a class="remove" href="#" onclick="removeImage(0)"><i class="icon-close"></i></a>

<label for="src1"><img id="target1" src="../images/book-placeholder.png" class="thumbnail"/></label>
<input id="src1" type="file"/>
<a class="remove" href="#" onclick="removeImage(1)"><i class="icon-close"></i></a>

<label for="src2"><img id="target2" src="../images/book-placeholder.png" class="thumbnail"/></label>
<input id="src2" type="file"/>
<a class="remove" href="#" onclick="removeImage(2)"><i class="icon-close"></i></a>

<label for="src3"><img id="target3" src="../images/book-placeholder.png" class="thumbnail"/></label>
<input id="src3" type="file"/>
<a class="remove" href="#" onclick="removeImage(3)"><i class="icon-close"></i></a>

<label for="src4"><img id="target4" src="../images/book-placeholder.png" class="thumbnail"/></label>
<input id="src4" type="file"/>
<a class="remove" href="#" onclick="removeImage(4)"><i class="icon-close"></i></a>

<button onclick="return uploadAll();">Upload all
</button>
<br>
<br>

<a onclick="showModal(); return false" data-toggle="modal" data-target="#addBookModal">
    <span>Add book</span>
</a>

<!--<button onclick="showModal(); return false" data-toggle="modal">open modal</button>-->
<div class="modal" id="addBookModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
     aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="myModalLabel">Add book</h4>
            </div>
            <div class="modal-body">
                <div class="form-group required">
                    <label for="book_title" class="control-label">Title </label>
                    <input type="text" class="form-control" id="book_title" placeholder="">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal"
                        onclick="showTooltip(); return false">
                    Close
                </button>
                <button type="button" class="btn btn-info" onclick="saveBook(); return false">
                    Add book
                </button>
            </div>
        </div>
    </div>
</div>


<!--
<div id="popupBottom" class="popover">
    <div class="arrow"></div>
    <h3 class="popover-title">Bottom</h3>
    <div class="popover-content">
        <p>Sed posuere consectetur est at lobortis. Aenean eu leo quam.
            Pellentesque ornare sem lacinia quam venenatis vestibulum.
            <a href="#" class="btn btn-default helloWorld">Click me</a>
        </p>
    </div>
</div>
-->

<script>

    function showModal() {
        let modal = document.getElementById("addBookModal").modal;
        modal.style.display = "block";

        // $('#addBookModal').modal('show');
    }

    function showTooltip() {
        alert('show');
        $('#addBookModal').modalPopover(options);
    }

    const NO_IMAGE = 'images/book-placeholder.png';
    let fileButton = document.getElementById("fileButton"),
        fileInput = document.getElementById("fileInput");

    fileButton.addEventListener("click", function (e) {
        if (fileInput) {
            fileInput.click();
        }
        e.preventDefault();
    }, false);

    function handleFiles(files) {
        let max = files.length < 5 ? files.length : 5;

        for (let i = 0; i < max; i++) {
            handleFile(i, files[i])
        }
    }

    function handleFile(i, file) {
        let fr = new FileReader();
        fr.onload = function (e) {
            target.src = this.result;
        };

        fr.readAsDataURL(file);
        let target = document.getElementById("target" + i);
    }

    function showImage(src, target) {
        let fr = new FileReader();
        fr.onload = function (e) {
            target.src = this.result;
        };
        src.addEventListener("change", function () {
            fr.readAsDataURL(src.files[0]);
        });
    }

    function removeImage(i) {
        let className = 'target' + i;
        let element = document.getElementById(className);
        element.src = NO_IMAGE;
    }

    function uploadAll() {
        let filesArray = [];
        for (let i = 0; i < 5; i++) {
            let file64 = document.getElementById('target' + i).src;
            if (!file64.includes(NO_IMAGE)) {

                let source2parts = file64.split(','),
                    mime = source2parts[0].match(/:(.*?);/)[1],
                    base64data = atob(source2parts[1]);

                let base64dataLength = base64data.length;
                let int8array = new Uint8Array(base64dataLength);
                for (let c = 0; c < base64dataLength; c++) {
                    int8array[c] = base64data.charCodeAt(c);
                }

                console.log(int8array);
                const name = `${Math.random().toString(36).slice(-5)}.jpg`;
                const file = new File([int8array], name, {type: mime});
                console.log('file', file);
                filesArray.push(file);
            }
        }
        if (filesArray != null) {
            upload(filesArray, 5);
        }
    }

    function upload(filesToUpload, bookId) {
        let formData = new FormData();
        for (let i = 0; i < filesToUpload.length; i++) {
            formData.append('files', filesToUpload[i]);
        }
        formData.append('bookId', bookId);

        let xhr = new XMLHttpRequest();
        xhr.onreadystatechange = function () {
            if (this.readyState == 4) {
                if (this.status == 500) {
                    showWarningModal("When adding the image, there is a server error");
                    return false;
                } else if (this.status == 403) {
                    showWarningModal("When adding the image, there is a problem with authentication");
                    return false;
                } else if (this.status == 200) {
                    console.log("Image added!");
                }
            }
        };

        let requestUrl = HOME_PAGE + "/images/upload";
        console.log(requestUrl);
        let token = 'eyJhbGciOiJIUzUxMiJ9.eyJzdWIiOiJiZXp6dWJpayIsImV4cCI6MTYwMDExNzIwMH0.FP9JTOJ_Pu5tWpJVca2kfvTN3IIPJIfc-I58gxaMBx9orzztBnPTjGUBSAC2xmmr5yszLPu4irA_UzJiB8Z26w';

        xhr.open("POST", requestUrl);
        xhr.setRequestHeader('Authorization', 'Bearer ' + token);
        // xhr.setRequestHeader('Accept', 'application/json');
        // addAuthorization(xhr);
        xhr.send(formData);
    }

    let src0 = document.getElementById("src0");
    let target0 = document.getElementById("target0");
    showImage(src0, target0);

    let src1 = document.getElementById("src1");
    let target1 = document.getElementById("target1");
    showImage(src1, target1);

    let src2 = document.getElementById("src2");
    let target2 = document.getElementById("target2");
    showImage(src2, target2);

    let src3 = document.getElementById("src3");
    let target3 = document.getElementById("target3");
    showImage(src3, target3);

    let src4 = document.getElementById("src4");
    let target4 = document.getElementById("target4");
    showImage(src4, target4);


</script>

<script src="../js/main.js"></script>


</body>
</html>
